generator client {
  provider   = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id               String     @id @default(uuid())
  email            String     @unique
  name             String?
  role             String     @default("DONOR") // Enum: Role
  createdAt        DateTime   @default(now())
  corporateProfile Corporate?
  ngoProfile       NGO?
}

model NGO {
  id             String          @id @default(uuid())
  userId         String          @unique
  orgName        String
  registrationNo String?
  ngoType        String          @default("TRUST") // Enum: NgoType
  city           String
  state          String
  pincode        String?
  address        String?
  mission        String?
  // Contact Person
  contactPerson  String?
  designation    String?
  mobile         String?
  website        String?
  // Legal & Compliance
  pan            String?
  darpanId       String?
  csr1Number     String?
  fcraRenewalDate DateTime?
  lastAuditDate   DateTime?

  // Compliance Freshness Tracking (NEW)
  validity12A         DateTime?
  validity80G         DateTime?
  validityCSR1        DateTime?
  lastComplianceCheck DateTime?
  
  // Financial Metrics (For Trust Score)
  annualBudget    Float   @default(0)
  expenseRatio    Float   @default(15.0) // Overhead % (lower is better)
  financialStrain Float   @default(0.0) // Volatility index

  // Verifications
  is12AVerified  Boolean         @default(false)
  is80GVerified  Boolean         @default(false)
  fcraStatus     Boolean         @default(false)
  trustScore     Int             @default(0) // Now calculated dynamically
  trustBreakdown String?         @default("{}") // JSON string for score breakdown
  
  createdAt      DateTime        @default(now())
  
  // Admin Controls
  systemStatus   String          @default("ACTIVE") // ACTIVE, SUSPENDED, BLACKLISTED, UNDER_REVIEW
  adminNotes     String?

  documents      ComplianceDoc[]
  complianceLogs ComplianceLog[] // Audit Trail
  user           User            @relation(fields: [userId], references: [id])
  projects       Project[]
}

model Corporate {
  id           String     @id @default(uuid())
  userId       String     @unique
  companyName  String
  industry     String
  csrBudget    Float
  mandateAreas String
  
  // Admin Controls
  systemStatus String   @default("ACTIVE")
  adminNotes   String?

  user         User       @relation(fields: [userId], references: [id])
  donations    Donation[]
  opportunities Opportunity[]
}

model Opportunity {
  id          String   @id @default(uuid())
  corporateId String
  title       String
  description String
  budget      Float    // Grant Amount
  deadline    DateTime
  type        String   @default("GRANT") // "GRANT", "CONTEST"
  status      String   @default("OPEN") // OPEN, CLOSED, AWARDED
  
  corporate   Corporate @relation(fields: [corporateId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Project {
  id           String     @id @default(uuid())
  ngoId        String
  title        String
  description  String
  targetAmount Float
  raisedAmount Float      @default(0)
  location     String
  sector       String
  status       String
  createdAt    DateTime   @default(now())
  donations    Donation[]
  ngo          NGO        @relation(fields: [ngoId], references: [id])
  tranches     Tranche[]
  complianceDocs ProjectComplianceDoc[]
}

model Tranche {
  id              String        @id @default(uuid())
  projectId       String
  amount          Float
  status          String        @default("LOCKED") // Enum: TrancheStatus
  unlockCondition String
  
  // Funding Block Logic (NEW)
  isBlocked            Boolean?
  blockReason          String? // "MISSING_UC", "COMPLIANCE_EXPIRED_12A", "GEO_MISMATCH"
  expectedEvidenceType String? // "PHOTO_GEO", "VIDEO", "DOC_PDF"

  // Escrow & Verification Logic
  releaseRequested Boolean      @default(false)
  proofDocUrl     String?       // UC or Photo Evidence
  geoTag          String?       // "Lat,Long" for geo-fencing check
  reviewedBy      String?       // Corporate User ID
  
  project         Project       @relation(fields: [projectId], references: [id])
}

model Donation {
  id          String    @id @default(uuid())
  corporateId String
  projectId   String
  amount      Float
  date        DateTime  @default(now())
  corporate   Corporate @relation(fields: [corporateId], references: [id])
  project     Project   @relation(fields: [projectId], references: [id])
}

model ComplianceDoc {
  id      String             @id @default(uuid())
  ngoId   String
  docType String
  url     String
  status  String             @default("PENDING") // Enum: VerificationStatus
  ngo     NGO                @relation(fields: [ngoId], references: [id])
}

// New Audit Log Model
model ComplianceLog {
  id          String   @id @default(uuid())
  ngoId       String
  docType     String   // "12A", "80G", "UC", "PROJECT_EVIDENCE"
  action      String   // "UPLOAD", "VERIFY", "REJECT", "EXPIRE"
  actorId     String   // Who did it? (User ID)
  timestamp   DateTime @default(now())
  metadata    String?  // JSON: { "oldVal": "...", "newVal": "...", "reason": "..." }
  
  ngo         NGO      @relation(fields: [ngoId], references: [id])
}

model ProjectComplianceDoc {
  id          String           @id @default(uuid())
  projectId   String
  category    String           // A, B, C, D, E, F
  docName     String           // Specific document name
  url         String?          
  status      String           @default("PENDING") // Enum: ComplianceStatus
  lastUpdated DateTime         @updatedAt
  verifiedBy  String?          // User ID of verifier
  remarks     String?

  project     Project          @relation(fields: [projectId], references: [id])
}

// New Admin User Model
model AdminUser {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String
  role      String   @default("READ_ONLY") // SUPER_ADMIN, COMPLIANCE, FINANCE, READ_ONLY
  lastLogin DateTime?
  isActive  Boolean  @default(true)
  
  auditLogs AdminAuditLog[] // Reverse relation
}

// Immutable Admin Audit Log
model AdminAuditLog {
  id          String   @id @default(uuid())
  adminId     String
  action      String   // "SUSPEND_NGO", "OVERRIDE_SCORE", "APPROVE_KYC"
  targetEntity String  // "NGO:123", "PROJECT:456"
  details     String?  // JSON: { reason: "Found fake docs", oldValue: "ACTIVE", newValue: "SUSPENDED" }
  ipAddress   String?
  timestamp   DateTime @default(now())

  admin       AdminUser @relation(fields: [adminId], references: [id])
}

// Document Upload Tracking Table
model DocumentUpload {
  id              String   @id @default(uuid())
  ngoId           String
  ngoName         String
  projectId       String?
  projectName     String?
  documentType    String   // "UC", "PHOTO", "12A", "80G", "FCRA", etc.
  fileName        String
  fileUrl         String
  fileSize        Int?     // in bytes
  uploadedBy      String   // User ID
  uploadedAt      DateTime @default(now())
  status          String   @default("PENDING") // PENDING, VERIFIED, REJECTED
  verifiedBy      String?
  verifiedAt      DateTime?
  remarks         String?
}

// Real-time Chat System
model ChatRoom {
  id          String    @id @default(uuid())
  corporateId String
  ngoId       String
  createdAt   DateTime  @default(now())
  lastMessageAt DateTime @default(now())
  
  messages    ChatMessage[]
  
  @@unique([corporateId, ngoId])
}

model ChatMessage {
  id         String   @id @default(uuid())
  roomId     String
  senderId   String   // User ID
  senderRole String   // "CORPORATE" or "NGO"
  senderName String
  message    String   @db.Text
  messageType String  @default("TEXT") // TEXT, SYSTEM, DOCUMENT_REQUEST, DOCUMENT_UPLOAD
  metadata   String?  @db.Text // JSON for additional data
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())
  
  room       ChatRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)
  
  @@index([roomId])
  @@index([createdAt])
}

// Real-time Notifications
model Notification {
  id          String   @id @default(uuid())
  userId      String   // Recipient user ID
  userRole    String   // "CORPORATE" or "NGO"
  type        String   // "CHAT", "DOCUMENT_REQUEST", "DOCUMENT_UPLOADED", "TRANCHE_REQUEST", "TRANCHE_APPROVED"
  title       String
  message     String   @db.Text
  link        String?  // URL to navigate to
  metadata    String?  @db.Text // JSON for additional data
  isRead      Boolean  @default(false)
  createdAt   DateTime @default(now())
  
  @@index([userId, isRead])
  @@index([createdAt])
}

// Document Request Tracking
model DocumentRequest {
  id          String   @id @default(uuid())
  corporateId String
  ngoId       String
  projectId   String?
  requestType String   // "COMPLIANCE_DOC", "UTILIZATION_CERTIFICATE", "IMPACT_REPORT", "TRANCHE_EVIDENCE"
  docName     String   // Specific document requested
  description String?  @db.Text
  priority    String   @default("MEDIUM") // HIGH, MEDIUM, LOW
  status      String   @default("PENDING") // PENDING, UPLOADED, VERIFIED, REJECTED
  requestedAt DateTime @default(now())
  uploadedAt  DateTime?
  fileUrl     String?
  remarks     String?
  
  @@index([ngoId, status])
  @@index([corporateId])
}


