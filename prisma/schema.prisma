generator client {
  provider   = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String     @id @default(uuid())
  email            String     @unique
  name             String?
  role             Role       @default(DONOR)
  createdAt        DateTime   @default(now())
  corporateProfile Corporate?
  ngoProfile       NGO?
}

model NGO {
  id             String          @id @default(uuid())
  userId         String          @unique
  orgName        String
  registrationNo String?
  ngoType        NgoType         @default(TRUST)
  city           String
  state          String
  pincode        String?
  address        String?
  mission        String?
  // Contact Person
  contactPerson  String?
  designation    String?
  mobile         String?
  website        String?
  // Legal & Compliance
  pan            String?
  darpanId       String?
  csr1Number     String?
  fcraRenewalDate DateTime?
  lastAuditDate   DateTime?
  
  // Financial Metrics (For Trust Score)
  annualBudget    Float   @default(0)
  expenseRatio    Float   @default(15.0) // Overhead % (lower is better)
  financialStrain Float   @default(0.0) // Volatility index

  // Verifications
  is12AVerified  Boolean         @default(false)
  is80GVerified  Boolean         @default(false)
  fcraStatus     Boolean         @default(false)
  trustScore     Int             @default(0) // Now calculated dynamically
  trustBreakdown String?         @default("{}") // JSON string for score breakdown
  
  createdAt      DateTime        @default(now())
  documents      ComplianceDoc[]
  user           User            @relation(fields: [userId], references: [id])
  projects       Project[]
}

enum NgoType {
  TRUST
  SOCIETY
  SECTION_8
  OTHER
}

model Corporate {
  id           String     @id @default(uuid())
  userId       String     @unique
  companyName  String
  industry     String
  csrBudget    Float
  mandateAreas String
  user         User       @relation(fields: [userId], references: [id])
  donations    Donation[]
  opportunities Opportunity[]
}

model Opportunity {
  id          String   @id @default(uuid())
  corporateId String
  title       String
  description String
  budget      Float    // Grant Amount
  deadline    DateTime
  type        String   @default("GRANT") // "GRANT", "CONTEST"
  status      String   @default("OPEN") // OPEN, CLOSED, AWARDED
  
  corporate   Corporate @relation(fields: [corporateId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Project {
  id           String     @id @default(uuid())
  ngoId        String
  title        String
  description  String
  targetAmount Float
  raisedAmount Float      @default(0)
  location     String
  sector       String
  status       String
  createdAt    DateTime   @default(now())
  donations    Donation[]
  ngo          NGO        @relation(fields: [ngoId], references: [id])
  tranches     Tranche[]
}

model Tranche {
  id              String        @id @default(uuid())
  projectId       String
  amount          Float
  status          TrancheStatus @default(LOCKED)
  unlockCondition String
  
  // Escrow & Verification Logic
  releaseRequested Boolean      @default(false)
  proofDocUrl     String?       // UC or Photo Evidence
  geoTag          String?       // "Lat,Long" for geo-fencing check
  reviewedBy      String?       // Corporate User ID
  
  project         Project       @relation(fields: [projectId], references: [id])
}

model Donation {
  id          String    @id @default(uuid())
  corporateId String
  projectId   String
  amount      Float
  date        DateTime  @default(now())
  corporate   Corporate @relation(fields: [corporateId], references: [id])
  project     Project   @relation(fields: [projectId], references: [id])
}

model ComplianceDoc {
  id      String             @id @default(uuid())
  ngoId   String
  docType String
  url     String
  status  VerificationStatus @default(PENDING)
  ngo     NGO                @relation(fields: [ngoId], references: [id])
}

enum Role {
  ADMIN
  NGO
  CORPORATE
  DONOR
}

enum VerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum TrancheStatus {
  LOCKED
  UNLOCKED
  DISBURSED
}
